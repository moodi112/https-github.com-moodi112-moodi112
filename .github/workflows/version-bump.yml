name: ðŸ”¢ Auto Version Bump

on:
  push:
    branches: [main, moodi112-patch-1]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  bump-version:
    name: ðŸ”¢ Bump Version
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[no-version]')"
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install bump2version
        run: pip install bump2version

      - name: Create version file
        run: |
          if [ ! -f VERSION ]; then
            echo "0.1.0" > VERSION
          fi

      - name: Create .bumpversion.cfg
        run: |
          cat > .bumpversion.cfg << 'EOF'
          [bumpversion]
          current_version = 0.1.0
          commit = True
          tag = True
          tag_name = v{new_version}
          message = chore: bump version to {new_version} [skip ci]
          
          [bumpversion:file:VERSION]
          
          [bumpversion:file:src/__init__.py]
          search = __version__ = "{current_version}"
          replace = __version__ = "{new_version}"
          EOF

      - name: Update src/__init__.py with version
        run: |
          if [ ! -f src/__init__.py ] || ! grep -q "__version__" src/__init__.py; then
            VERSION=$(cat VERSION 2>/dev/null || echo "0.1.0")
            echo "__version__ = \"$VERSION\"" >> src/__init__.py
          fi

      - name: Determine version bump type
        id: bump_type
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          if [[ "$COMMIT_MSG" == *"BREAKING CHANGE"* ]] || [[ "$COMMIT_MSG" == *"feat!"* ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" == feat:* ]] || [[ "$COMMIT_MSG" == *"feature:"* ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        run: |
          BUMP_TYPE="${{ github.event.inputs.version_type || steps.bump_type.outputs.type }}"
          
          # Get current version
          CURRENT_VERSION=$(cat VERSION 2>/dev/null || echo "0.1.0")
          
          # Update .bumpversion.cfg with current version
          sed -i "s/current_version = .*/current_version = $CURRENT_VERSION/" .bumpversion.cfg
          
          # Perform bump
          bump2version $BUMP_TYPE --allow-dirty || true
          
          # Get new version
          NEW_VERSION=$(cat VERSION)
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin ${{ github.ref_name }}
          git push --tags
        continue-on-error: true
